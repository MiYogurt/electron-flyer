<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安装依赖 | 破晓：黑夜之中的 Electron 飞行指南</title>
    <meta name="description" content="🎨 Electron 没那么难">
    
    
    <link rel="preload" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css" as="style"><link rel="preload" href="/electron-flyer/assets/js/app.321478e2.js" as="script"><link rel="preload" href="/electron-flyer/assets/js/15.4888b394.js" as="script"><link rel="prefetch" href="/electron-flyer/assets/js/10.d6a7e726.js"><link rel="prefetch" href="/electron-flyer/assets/js/11.887eb323.js"><link rel="prefetch" href="/electron-flyer/assets/js/12.91b28bd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/13.2a080c63.js"><link rel="prefetch" href="/electron-flyer/assets/js/14.e6db4937.js"><link rel="prefetch" href="/electron-flyer/assets/js/16.6209dfc4.js"><link rel="prefetch" href="/electron-flyer/assets/js/17.4dabdbda.js"><link rel="prefetch" href="/electron-flyer/assets/js/18.d91d10ee.js"><link rel="prefetch" href="/electron-flyer/assets/js/19.2288f168.js"><link rel="prefetch" href="/electron-flyer/assets/js/2.6cf72073.js"><link rel="prefetch" href="/electron-flyer/assets/js/20.1d66ae28.js"><link rel="prefetch" href="/electron-flyer/assets/js/21.1073c24e.js"><link rel="prefetch" href="/electron-flyer/assets/js/22.9864bcb1.js"><link rel="prefetch" href="/electron-flyer/assets/js/23.0099ea93.js"><link rel="prefetch" href="/electron-flyer/assets/js/24.2924e65e.js"><link rel="prefetch" href="/electron-flyer/assets/js/25.9ffdaddc.js"><link rel="prefetch" href="/electron-flyer/assets/js/26.549bcbd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/3.7de79766.js"><link rel="prefetch" href="/electron-flyer/assets/js/4.e4c889ba.js"><link rel="prefetch" href="/electron-flyer/assets/js/5.968ec6b8.js"><link rel="prefetch" href="/electron-flyer/assets/js/6.0f1acbba.js"><link rel="prefetch" href="/electron-flyer/assets/js/7.08f680e1.js"><link rel="prefetch" href="/electron-flyer/assets/js/8.01be9bf3.js"><link rel="prefetch" href="/electron-flyer/assets/js/9.b7ab19cb.js">
    <link rel="stylesheet" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme__container sidebar-open"><div class="row"><div class="col-md-2"><div class="sidebar"><div class="group"><div class="group__title">章节内容</div> <div class="group__body"><!---->  <div name="1.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/1.html">初识 Electron</a></div> </div><div name="2.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/2.html">了解 Electron 开发环境</a></div> </div><div name="3.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/3.html">封装（一）</a></div> </div><div name="4.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/4.html">Typescript</a></div> </div><div name="5.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/5.html">获取小说内容命令行程序版（上）</a></div> </div><div name="6.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/6.html">获取小说内容命令行程序版（中）</a></div> </div><div name="7.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/7.html">获取小说内容命令行程序版（下）</a></div> </div><div name="8.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/8.html" class="router-link-exact-active router-link-active">嵌入到应用中</a></div> </div><div name="9.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/9.html">插件</a></div> </div><div name="10.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/10.html">文字转语音</a></div> </div><div name="11.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/11.html">设置与信号中断</a></div> </div><div name="12.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/12.html">插件商店</a></div> </div><div name="13.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/13.html">下载与删除（上）</a></div> </div><div name="14.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/14.html">下载与删除（下）</a></div> </div><div name="15.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/15.html">通知栏程序</a></div> </div><div name="16.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/16.html">播放功能</a></div> </div><div name="17.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/17.html">美化</a></div> </div><div name="18.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/18.html">数据可视化（上）</a></div> </div><div name="19.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/19.html">数据可视化（中）</a></div> </div><div name="20.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/20.html">数据可视化（下）</a></div> </div><div name="21.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/21.html">嵌入到应用中</a></div> </div><div name="22.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/22.html">打包</a></div> </div></div></div></div></div> <div class="col-md-10"><div class="page__container"><div class="content custom"><p>这一节，先去掉 <code>url-join</code> ，在 <code>ts</code> 环境下，似乎没法把 <code>require</code> 传递进去，所以我们只能暂时先抛弃这个功能。</p> <h2 id="安装依赖"><a href="#安装依赖" aria-hidden="true" class="header-anchor">#</a> 安装依赖</h2> <div class="language- extra-class"><pre class="language-text"><code>npm install iconv-lite cheerio fs-extra --save
</code></pre></div><ul><li>iconv-lite 是转码 gbk 工具，避免乱码</li> <li>cheerio 是服务端的 jquery 解析器</li> <li>fs-extra 文件增强模块</li></ul> <div class="language- extra-class"><pre class="language-text"><code>npm install @types/cheerio @types/iconv-lite @types/fs-extra --save-dev
</code></pre></div><p>TypeScript 只有在有定义文件的前提下，才能提供代码提示。</p> <ul><li>添加定义文件 <code>src/main/phin.d.ts</code></li></ul> <p>并非所有模块都有定义文件的，没有定义文件就只能自己写定义文件了。</p> <div class="language- extra-class"><pre class="language-text"><code>declare module 'phin' {
  export function promisified(url: string, opts?: any): Promise&lt;string&gt;
}
</code></pre></div><h2 id="定义接口"><a href="#定义接口" aria-hidden="true" class="header-anchor">#</a> 定义接口</h2> <p>为了使程序更加的 <code>TypeScript</code>，所以我们需要定义一些接口，来约定开发规范，新建 <code>src/main/crawl.ts</code></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'electron'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">downloadOptions</span> <span class="token punctuation">{</span>
  <span class="token comment">// 下载选项</span>
  path<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token comment">// ？ 表示可选属性，路径</span>
  concurrence<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token comment">// 并发量</span>
  waitTime<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token comment">// 等待事件</span>
  charset<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token comment">// 字符集</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> defaultOptions<span class="token punctuation">:</span> downloadOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置一个默认值</span>
  path<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'xiaoshuo'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  concurrence<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  waitTime<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
  charset<span class="token punctuation">:</span> <span class="token string">'utf-8'</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> defaultOptions <span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Chatper</span> <span class="token punctuation">{</span>
  <span class="token comment">// 章节的数据</span>
  title<span class="token punctuation">:</span> <span class="token builtin">string</span>
  url<span class="token punctuation">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Crawl</span> <span class="token punctuation">{</span>
  <span class="token comment">// 爬取规则需要提供的选项</span>
  opts<span class="token operator">?</span><span class="token punctuation">:</span> downloadOptions <span class="token comment">// 爬取选项。</span>
  <span class="token function">text</span><span class="token punctuation">(</span>select<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Chatper<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 章节内容爬取规则</span>
  <span class="token function">chapter</span><span class="token punctuation">(</span>select<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Chatper<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 爬取章节的规则</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个文件里面真正有作用的只有 <code>defaultOptions</code> ，<code>interface</code> 在编译的时候会被删除掉。也就是说，静态类型只会停留咋 ts 层面。</p> <h2 id="状态通信"><a href="#状态通信" aria-hidden="true" class="header-anchor">#</a> 状态通信</h2> <p>为了让下载状态可以传输到渲染进程，我们需要创建 IPC 通信的信道，我们可以用 <code>Subject</code> 封装一下，<code>Subject</code> 的实例可以调用 <code>next</code> 方法，传递进去的参数，会原样传递给 <code>subscribe</code> 里面的回调。 新建 <code>statusLog.ts</code> 。</p> <blockquote><p>封装成 subject 有啥好处？</p> <p>单个来看，其实没啥好处。只不过比较 Rxjs，容易跟其他操作符结合。</p></blockquote> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mainWindow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span>

<span class="token keyword">interface</span> <span class="token class-name">Log</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token comment">// 类型</span>
  step<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token comment">// 第几步</span>
  percent<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token comment">// 百分比</span>
  message<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token comment">// 消息</span>
  <span class="token punctuation">[</span>index<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token comment">// 其他属性，只要属性名为 string 类型，值为 any 任意类型都可以</span>
<span class="token punctuation">}</span>

<span class="token comment">// 发送状态显示给用户</span>
<span class="token keyword">const</span> <span class="token function-variable function">createLog</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> log$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token operator">&lt;</span>Log<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  log$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
    <span class="token parameter">log</span> <span class="token operator">=&gt;</span> mainWindow <span class="token operator">&amp;&amp;</span> mainWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'download-status'</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span> <span class="token comment">// 主线程发送到渲染进程通过 webContents 上下文发送。</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> log$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>log$<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// (log: Log) =&gt; void 表示匿名函数的类型， void 表示空</span>
<span class="token keyword">const</span> <span class="token function-variable function">log</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">log<span class="token punctuation">:</span> Log</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token operator">=</span> <span class="token function">createLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> log
</code></pre></div><p>这里我们还定义了一下通信的格式接口，传递信息给渲染进程，必须要拿到窗口实例，我们可以在 <code>index.ts</code> 里面导出一下这个实例。这里一定要绑定一下 <code>this</code> 的指向，要不然会报错。</p> <h2 id="下载"><a href="#下载" aria-hidden="true" class="header-anchor">#</a> 下载</h2> <p>现在我们将上一节的内容改成 <code>TypeScript</code> 的版本，一些检测函数我用 <code>fs-extra</code> 进行了代替，这样看起来会更简洁些。</p> <ul><li>导入依赖与接口</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> promisified <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'phin'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'http'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'iconv-lite'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> load <span class="token keyword">as</span> cheerio <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cheerio'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> writeJSON<span class="token punctuation">,</span> ensureDir<span class="token punctuation">,</span> readJson <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs-extra'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token keyword">of</span><span class="token punctuation">,</span> timer<span class="token punctuation">,</span> throwError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> pluck<span class="token punctuation">,</span> map<span class="token punctuation">,</span> concatAll <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span>

<span class="token keyword">import</span> log <span class="token keyword">from</span> <span class="token string">'./statusLog'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> downloadOptions<span class="token punctuation">,</span> defaultOptions<span class="token punctuation">,</span> Crawl<span class="token punctuation">,</span> Chatper <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./crawl'</span>
</code></pre></div><ul><li>定义一些初始函数</li></ul> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 请求</span>
<span class="token keyword">const</span> <span class="token function-variable function">request</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">from</span><span class="token punctuation">(</span><span class="token function">promisified</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// promise 化</span>

<span class="token comment">// cheerio 载入</span>
<span class="token keyword">const</span> <span class="token function-variable function">toSelector</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">cheerio</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">throwError</span><span class="token punctuation">(</span><span class="token string">'没有抓取到内容'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理 301、302</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleFollowRedirect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">:</span> ServerRequest</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span> <span class="token operator">=</span> res
  <span class="token keyword">if</span> <span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">)</span> <span class="token comment">// 301 是 location 跳转</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 再次通过 rxjs 实例包裹</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>from</code> 会把 <code>event</code> 事件、<code>Promise</code> 、数组转换成 Rxjs 的 <code>Observable</code>，这样我们就可以使用 Rxjs 的操作符了，对于 Observable 可以理解为 <code>Promise</code> 多次触发版本，或者数组，亦或者 <code>stream</code>，且用 <code>subscribe</code> 代替了 <code>then</code> 。<code>of</code> 其实就是类似与数组的 <code>Array.of</code> 表示用 Observable 包裹一下这个变量。</p> <p>对于 headers 里面有 location 的，表示有重定向，再次请求这个地址即可，不过为了统一，都输出 Observable 的实例，所有用 of 包裹了一下原来的响应数据。</p> <p>在后面加一个 <code>!</code> 叹号表示，它一定不为空。</p> <h2 id="构建选择器"><a href="#构建选择器" aria-hidden="true" class="header-anchor">#</a> 构建选择器</h2> <p>这两段代码可能有些小难，可以参考源码里面完成的内容进行阅读。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 解码</span>
<span class="token keyword">const</span> decodeCharset <span class="token operator">=</span> <span class="token punctuation">(</span>charset<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">:</span> Buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">decode</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> charset<span class="token punctuation">)</span>

<span class="token comment">// 获取选择器</span>
<span class="token keyword">const</span> <span class="token function-variable function">getSelector</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> charset<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">map</span><span class="token punctuation">(</span>handleFollowRedirect<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 对结果处理 301</span>
    <span class="token function">concatAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 假如处理了 301 , 是 2 层的 Observable 实例 ，铺平它</span>
    <span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 拿到 res.body</span>
    <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">decodeCharset</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 转码</span>
    <span class="token function">map</span><span class="token punctuation">(</span>toSelector<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 构造选择器</span>
    <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 捕获错误</span>
      <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre></div><p>首先对解码进行柯里化，<code>map</code> 就像数组 <code>[].map</code> 对数组里面的每一个元素进行操作，这不过我们这里面只有一个数据，即请求 url 的结果。为了处理跳转，我们又将它的返回值变成了 <code>Observable</code> 的实例，也就是说需要 <code>subscribe</code> 才能拿到里面的结果。他就像一个高阶的 <code>Observable</code> ，<code>Observable</code> 里面还有一个 <code>Observable</code> ，使用 <a href="https://rxjs-cn.github.io/learn-rxjs-operators/operators/combination/concatall.html" target="_blank" rel="noopener noreferrer">concatAll<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以把它解出来，并连接起来。这样我们就可以得到响应的结果，通过 <code>pluck('body')</code> 拿到 <code>body</code> 属性，然后解码，装载 <code>cherrio</code> ，最后有一个捕获错误的回调，捕获错误的回调还是要有返回一个 Observable 的。</p> <h2 id="下载章节"><a href="#下载章节" aria-hidden="true" class="header-anchor">#</a> 下载章节</h2> <p> 执行下载章节逻辑，这里我们通过 log 把消息发送到渲染进程，这样就可以显示百分比。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">downloadChapter</span><span class="token punctuation">(</span>
  <span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  crawl<span class="token punctuation">:</span> Crawl<span class="token punctuation">,</span>
  opts<span class="token punctuation">:</span> Required<span class="token operator">&lt;</span>downloadOptions<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'chapter'</span><span class="token punctuation">,</span> percent<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> charset <span class="token punctuation">}</span> <span class="token operator">=</span> opts
  <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> charset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'chapter'</span><span class="token punctuation">,</span> percent<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> chatpers <span class="token operator">=</span> crawl<span class="token punctuation">.</span><span class="token function">chapter</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token keyword">const</span> savePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`chapters.json`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">writeJSON</span><span class="token punctuation">(</span>savePath<span class="token punctuation">,</span> chatpers<span class="token punctuation">)</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'chapter'</span><span class="token punctuation">,</span> percent<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Required&lt;T&gt;</code> 可以将属性都变成必须存在的。<code>toPromise()</code> 可以将 <code>Observable</code> 转换为 <code>Promise</code> 对象处理。</p> <p>其实也可以用 Rxjs 来改造一下</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">downloadChapter</span><span class="token punctuation">(</span>
  <span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  crawl<span class="token punctuation">:</span> Crawl<span class="token punctuation">,</span>
  opts<span class="token punctuation">:</span> Required<span class="token operator">&lt;</span>downloadOptions<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> charset <span class="token punctuation">}</span> <span class="token operator">=</span> opts
  <span class="token keyword">const</span> savePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`chapters.json`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> charset<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'chapter'</span><span class="token punctuation">,</span> percent<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// tap 表示处理的时候顺带执行以下这里面的内容，但是不修改原来的数据</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">$</span> <span class="token operator">=&gt;</span> crawl<span class="token punctuation">.</span><span class="token function">chapter</span><span class="token punctuation">(</span>$<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'chapter'</span><span class="token punctuation">,</span> percent<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">chatpers</span> <span class="token operator">=&gt;</span> <span class="token function">writeJSON</span><span class="token punctuation">(</span>savePath<span class="token punctuation">,</span> chatpers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'chapter'</span><span class="token punctuation">,</span> percent<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>tap 是按照原样输出，就像 1 乘以任何数都等于它原来的数，只不过执行一下里面的方法而已。</p> <h2 id="下载单个内容"><a href="#下载单个内容" aria-hidden="true" class="header-anchor">#</a> 下载单个内容</h2> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">downloadText</span><span class="token punctuation">(</span>
  <span class="token parameter">chapter<span class="token punctuation">:</span> Chatper<span class="token punctuation">,</span>
  crawl<span class="token punctuation">:</span> Crawl<span class="token punctuation">,</span>
  index<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  opts<span class="token punctuation">:</span> Required<span class="token operator">&lt;</span>downloadOptions<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> charset <span class="token punctuation">}</span> <span class="token operator">=</span> opts
  <span class="token keyword">const</span> savePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`text/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chapter<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">)</span> <span class="token comment">// 存储路径</span>
  <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>chapter<span class="token punctuation">.</span>url<span class="token punctuation">,</span> charset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// $ 选择器</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> crawl<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">writeJSON</span><span class="token punctuation">(</span>savePath<span class="token punctuation">,</span> text<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="并发控制下载所有内容"><a href="#并发控制下载所有内容" aria-hidden="true" class="header-anchor">#</a> 并发控制下载所有内容</h2> <p>这次我们换一种方式来实现，先分割数组，然后通过闭包构建一个懒函数，在下载的时候再获取 Promise 数组。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">chunk</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> retArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> array<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> index <span class="token operator">+</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
    index <span class="token operator">+=</span> chunkSize
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> retArr
<span class="token punctuation">}</span>
</code></pre></div><p>chunk 最主要用来分割，分割成二维数组。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">invoke</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">:</span> <span class="token builtin">Function</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用传递进来的函数</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">downloadAllText</span><span class="token punctuation">(</span><span class="token parameter">crawl<span class="token punctuation">:</span> Crawl<span class="token punctuation">,</span> opts<span class="token punctuation">:</span> Required<span class="token operator">&lt;</span>downloadOptions<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> concurrence<span class="token punctuation">,</span> waitTime <span class="token punctuation">}</span> <span class="token operator">=</span> opts
  <span class="token keyword">const</span> chaptersPath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'chapters.json'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> chapters <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readJson</span><span class="token punctuation">(</span>chaptersPath<span class="token punctuation">)</span>

  <span class="token keyword">const</span> needInvoke <span class="token operator">=</span> chapters<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chapter<span class="token punctuation">:</span> Chatper<span class="token punctuation">,</span> i<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">downloadText</span><span class="token punctuation">(</span>chapter<span class="token punctuation">,</span> crawl<span class="token punctuation">,</span> i<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token comment">// 需要被触发的函数数组</span>

  <span class="token keyword">let</span> chaptersChunk <span class="token operator">=</span> <span class="token function">chunk</span><span class="token punctuation">(</span>needInvoke<span class="token punctuation">,</span> concurrence<span class="token punctuation">)</span> <span class="token comment">// 分割</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> chaptersChunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promies<span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> chaptersChunk<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>invoke<span class="token punctuation">)</span> <span class="token comment">// 构建 promise 数组</span>
    <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promies<span class="token punctuation">)</span> <span class="token comment">// 调用</span>
    <span class="token keyword">const</span> percent <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>index <span class="token operator">/</span> chaptersChunk<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> first <span class="token operator">=</span>
      index <span class="token operator">*</span> concurrence <span class="token operator">&lt;=</span> chapters<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token operator">?</span> index <span class="token operator">*</span> concurrence
        <span class="token punctuation">:</span> chapters<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// 当前块第一个序号的索引</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span>
      step<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
      percent<span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> chapters<span class="token punctuation">[</span>first<span class="token punctuation">]</span><span class="token punctuation">.</span>title
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    waitTime <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">timer</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>timer 可以用来暂停执行，等待一小会，太快了容易报错。为了取到文章的标题，需要计算一下序号 <code>first</code></p> <h2 id="导出函数"><a href="#导出函数" aria-hidden="true" class="header-anchor">#</a> 导出函数</h2> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> crawl<span class="token punctuation">:</span> Crawl<span class="token punctuation">,</span> opts<span class="token punctuation">:</span> downloadOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opts <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultOptions<span class="token punctuation">,</span> crawl<span class="token punctuation">.</span>opts<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">ensureDir</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>path<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 确保文件存在</span>
    <span class="token keyword">await</span> <span class="token function">downloadChapter</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> crawl<span class="token punctuation">,</span> opts <span class="token keyword">as</span> Required<span class="token operator">&lt;</span>downloadOptions<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token comment">// 下载章节</span>
    <span class="token keyword">await</span> <span class="token function">downloadAllText</span><span class="token punctuation">(</span>crawl<span class="token punctuation">,</span> opts <span class="token keyword">as</span> Required<span class="token operator">&lt;</span>downloadOptions<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token comment">// 下载内容</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'crawl'</span><span class="token punctuation">,</span> step<span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> e<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> download
</code></pre></div><p>将函数导出供 index.ts 使用</p> <h2 id="测试功能"><a href="#测试功能" aria-hidden="true" class="header-anchor">#</a> 测试功能</h2> <p>修改 <code>index.ts</code> , <code>test.js</code> 是跟上一节的类似，不过去掉了 <code>require</code> ，导出的就是一个对象。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> BrowserWindow<span class="token punctuation">,</span> ipcMain <span class="token keyword">as</span> ipc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'electron'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fromEvent<span class="token punctuation">,</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span>
<span class="token keyword">import</span> download <span class="token keyword">from</span> <span class="token string">'./download'</span>

<span class="token keyword">interface</span> <span class="token class-name">CombineEvent</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将原来的两个参数转成对象的接口</span>
  event<span class="token punctuation">:</span> <span class="token builtin">any</span>
  args<span class="token punctuation">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Subject<span class="token operator">&lt;</span>CombineEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> eventListner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token operator">&lt;</span>CombineEvent<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通过 next 可以派发时间的订阅者模式，里面每次派发的内容都是 CombineEvent</span>
  ipc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> args<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> eventListner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> event<span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> eventListner
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  mainWindow <span class="token operator">=</span> <span class="token function">createMainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建主窗口</span>
  <span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'download'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接受到下载事件的时候</span>
    <span class="token keyword">const</span> crawl <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'./test.js'</span><span class="token punctuation">)</span> <span class="token comment">// 命令行版本的源文件</span>
    <span class="token function">download</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>url<span class="token punctuation">,</span> crawl<span class="token punctuation">,</span> <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'./'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token builtin">console</span><span class="token punctuation">.</span>log<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新建 <code>renderer/Status.svelte</code>， 我们在这个里面发送下载事件，到主进程里面</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{JSON.stringify(status)}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{JSON.stringify(errors)}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>download()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>xiazai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span>
        ipcRenderer
    <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;electron&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                status<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 当前状态</span>
                errors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存储错误</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">oncreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 创建的时候调用的生命周期函数</span>
            ipcRenderer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;download-status&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 接受下载状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>step <span class="token operator">==</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> <span class="token punctuation">{</span>
                        errors
                    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// get 获取 data ，set 设置 data</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        errors
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    status<span class="token punctuation">:</span> args
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">download</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;download&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;download&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// 发送下载信号，与下载的地址</span>
                    url<span class="token punctuation">:</span> <span class="token string">&quot;https://www.ybdu.com/xiaoshuo/0/910&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>修改 <code>App.svelte</code>，载入这个刚刚写好的组件。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello {name}!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Status</span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">h1</span> <span class="token punctuation">{</span>
        <span class="token property">color</span><span class="token punctuation">:</span> purple<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> Status <span class="token keyword">from</span> <span class="token string">&quot;./Status.svelte&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        components<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            Status
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/electron-flyer/assets/img/download.4fd724a9.gif" alt="download"></p></div> <div class="content__footer-container"><div class="content__footer"><!----> <!----></div></div></div></div></div></div></div>
    <script src="/electron-flyer/assets/js/app.321478e2.js" defer></script><script src="/electron-flyer/assets/js/15.4888b394.js" defer></script>
  </body>
</html>
