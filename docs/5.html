<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何获取列表 | 破晓：黑夜之中的 Electron 飞行指南</title>
    <meta name="description" content="🎨 Electron 没那么难">
    
    
    <link rel="preload" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css" as="style"><link rel="preload" href="/electron-flyer/assets/js/app.22e63a91.js" as="script"><link rel="preload" href="/electron-flyer/assets/js/10.d6a7e726.js" as="script"><link rel="prefetch" href="/electron-flyer/assets/js/11.887eb323.js"><link rel="prefetch" href="/electron-flyer/assets/js/12.91b28bd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/13.2a080c63.js"><link rel="prefetch" href="/electron-flyer/assets/js/14.e6db4937.js"><link rel="prefetch" href="/electron-flyer/assets/js/15.4888b394.js"><link rel="prefetch" href="/electron-flyer/assets/js/16.6209dfc4.js"><link rel="prefetch" href="/electron-flyer/assets/js/17.4dabdbda.js"><link rel="prefetch" href="/electron-flyer/assets/js/18.d91d10ee.js"><link rel="prefetch" href="/electron-flyer/assets/js/19.2288f168.js"><link rel="prefetch" href="/electron-flyer/assets/js/2.182ecb78.js"><link rel="prefetch" href="/electron-flyer/assets/js/20.1d66ae28.js"><link rel="prefetch" href="/electron-flyer/assets/js/21.1073c24e.js"><link rel="prefetch" href="/electron-flyer/assets/js/22.9864bcb1.js"><link rel="prefetch" href="/electron-flyer/assets/js/23.0099ea93.js"><link rel="prefetch" href="/electron-flyer/assets/js/24.2924e65e.js"><link rel="prefetch" href="/electron-flyer/assets/js/25.9ffdaddc.js"><link rel="prefetch" href="/electron-flyer/assets/js/26.549bcbd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/3.7de79766.js"><link rel="prefetch" href="/electron-flyer/assets/js/4.fa89f104.js"><link rel="prefetch" href="/electron-flyer/assets/js/5.968ec6b8.js"><link rel="prefetch" href="/electron-flyer/assets/js/6.0f1acbba.js"><link rel="prefetch" href="/electron-flyer/assets/js/7.08f680e1.js"><link rel="prefetch" href="/electron-flyer/assets/js/8.01be9bf3.js"><link rel="prefetch" href="/electron-flyer/assets/js/9.b7ab19cb.js">
    <link rel="stylesheet" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme__container sidebar-open"><div class="row"><div class="col-md-2"><div class="sidebar"><div class="group"><div class="group__title">章节内容</div> <div class="group__body"><!---->  <div name="1.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/1.html">历史介绍</a></div> </div><div name="2.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/2.html">开发环境</a></div> </div><div name="3.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/3.html">代码封装</a></div> </div><div name="4.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/4.html">函数式</a></div> </div><div name="5.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/5.html" class="router-link-exact-active router-link-active">获取小说命令行版（上）</a></div> </div><div name="6.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/6.html">获取小说命令行版（中）</a></div> </div><div name="7.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/7.html">获取小说命令行版（下）</a></div> </div><div name="8.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/8.html">嵌入到应用中</a></div> </div><div name="9.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/9.html">插件机制</a></div> </div><div name="10.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/10.html">文字转语音</a></div> </div><div name="11.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/11.html">设置与信号中断</a></div> </div><div name="12.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/12.html">插件商店</a></div> </div><div name="13.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/13.html">下载与删除（上）</a></div> </div><div name="14.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/14.html">下载与删除（下）</a></div> </div><div name="15.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/15.html">通知栏程序</a></div> </div><div name="16.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/16.html">播放功能</a></div> </div><div name="17.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/17.html">美化界面</a></div> </div><div name="18.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/18.html">数据可视化（上）</a></div> </div><div name="19.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/19.html">数据可视化（中）</a></div> </div><div name="20.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/20.html">数据可视化（下）</a></div> </div><div name="21.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/21.html">嵌入到应用中</a></div> </div><div name="22.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/22.html">打包应用</a></div> </div></div></div></div></div> <div class="col-md-10"><div class="page__container"><div class="content custom"><p>这一小节以 <code>JavaScript</code> 和函数式来讲解，下一节将通过 <code>TypeScript</code> 和 <code>Rxjs</code> 实现。现在我们先获取一个小说的内容和章节，然后存储到 json 文件里面，以这个 <a href="https://www.ybdu.com/xiaoshuo/0/910/" target="_blank" rel="noopener noreferrer">斗罗大陆<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为例。</p> <h2 id="如何获取列表"><a href="#如何获取列表" aria-hidden="true" class="header-anchor">#</a> 如何获取列表</h2> <p><img src="/electron-flyer/assets/img/crawl_selector.b0539a1e.png" alt="crawl_selector"></p> <p><code>.mulu_list li</code> 选择器下面就是我们想要的内容，比较简单，<code>herf</code> 是链接，<code>text</code> 是标题。</p> <p><img src="/electron-flyer/assets/img/crawl_detail_selector.e7ffcc2f.png" alt="crawl_detail_selector"></p> <p>对于文章内容则是 <code>#htmlContent</code></p> <p>首先预想一下，需要一个什么样的文件，提供什么样的功能？于是期望输入一个小说的网址，根据内置的爬取规则获取章节信息，首先保存章节信息到文件里面，然后继续爬取章节里面的内容，存储的地址同样是一个函数输入，并且我们希望控制一下并发量。</p> <p>首先把它做成命令行的版本，便于直接测试，然后在后续再进行改写。</p> <h2 id="导入模块"><a href="#导入模块" aria-hidden="true" class="header-anchor">#</a> 导入模块</h2> <ul><li><code>phin</code> 是一个 node 下，基于 <code>net</code> 封装的一个请求模块，非常的小。</li> <li><code>cherrio</code> 则是类似于 <code>jquery</code> 的 <code>dom</code> 选取器。</li> <li><code>iconv-lite</code> 是纯 <code>javascript</code> 实现的一个字符编码解码器，主要用于解码 gbk，因为比较老的网站都是 gbk 编码的。</li> <li><code>jsonfile</code> 可以方便的读取 <code>json</code> 文件，保存数据的时候会用到它。</li> <li><code>url-join</code> 是拼接 <code>url</code> 的工具，有考虑到一些有 <code>query</code> 的情况，所以使用库拼接，而不是直接字符串拼接。</li> <li><code>make-dir</code> 用来确保文件地址存在和创建文件。</li> <li><code>ora</code> 则用于下载进度的显示</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'phin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promisified
<span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> decode <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'iconv-lite'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jsonfile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonfile'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> urljoin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url-join'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mkdir <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'make-dir'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="构建选择器"><a href="#构建选择器" aria-hidden="true" class="header-anchor">#</a> 构建选择器</h2> <p><code>pipeP</code>，第一个参数是 <code>Promise</code>，之后的参数都是 <code>then</code> 里面的回调，这样就再也不用看见 <code>then</code> 链了，然后将每一个环节进行分割，具体入下。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 拉取数据并且转码</span>
<span class="token keyword">const</span> <span class="token function-variable function">getHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> charset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">p</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token function">decode</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">,</span> charset<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 装载内容，获取 $ 函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">loadContent</span> <span class="token operator">=</span> <span class="token parameter">source</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token parameter">selector</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 去掉 then 链接</span>
<span class="token keyword">const</span> <span class="token function-variable function">pipeP</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> acc<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 组合成构建 $ 函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">buildSelector</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> charset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">pipeP</span><span class="token punctuation">(</span>
    <span class="token function">getHTML</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> charset<span class="token punctuation">)</span><span class="token punctuation">,</span>
    loadContent
  <span class="token punctuation">)</span>
</code></pre></div><p>其实这个还有一些优化的方向，有的时候我们经常写出这样的函数，我们首先来看 <code>loadContent</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loadContent</span> <span class="token operator">=</span> <span class="token parameter">source</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token parameter">selector</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loadContent <span class="token operator">=</span> cheerio<span class="token punctuation">.</span>load
</code></pre></div><blockquote><p>当一个函数的参数，原样传递给另外一个函数的时候，直接等于这个函数即可。</p></blockquote> <p>而对于 <code>getHTML</code> 也可以稍微优化一小下，到这个层次，我觉得就差不多了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> charset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">pipeP</span><span class="token punctuation">(</span>
    <span class="token function">p</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">decode</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> charset<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre></div><p>那么还有没有继续优化的空间了呢，是有的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">decodeHTML</span> <span class="token operator">=</span> <span class="token parameter">charset</span> <span class="token operator">=&gt;</span> <span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token function">decode</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> charset<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">getBody</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> body
<span class="token comment">// 拉取数据并且转码</span>
<span class="token keyword">const</span> <span class="token function-variable function">getHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> charset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">pipeP</span><span class="token punctuation">(</span>
    <span class="token function">p</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>
    getBody<span class="token punctuation">,</span>
    <span class="token function">decodeHTML</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre></div><p>那还可不可以继续优化呢，可以，不过需要用到帮助库 <code>ramda</code>，这里有一个问题使用 <code>curry</code> 自动柯里化的时候 <code>decode</code> 的 <code>length</code> 是 3，即接受 3 个参数 ，所以会导致出错。笔者调试了很久，最主要还是 API 文档导致的，API 上面显示的是两个参数，当我打印 <code>length</code> 的时候其实是 3 ，最后看了源码，发现有一个 <code>opts</code>，所以必须使用 <code>curryN</code> 表明个数，composeP 跟 pipeP 是顺序相反的，而且 <code>ramda</code> 的和笔者写的 <code>composeP</code> 跟 <code>pipeP</code> 有一些差异，<code>ramda</code> 的参数不是在第一个 <code>Promise</code> 里面传递的。这样优化，反而没有之前的清晰，这其实就属于过度的优化和函数式了，不要过度的函数式，也不要过度设计模式，过度的面向对象，物极必反。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> __<span class="token punctuation">,</span> flip<span class="token punctuation">,</span> curryN<span class="token punctuation">,</span> composeP<span class="token punctuation">,</span> prop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> decodeHTML <span class="token operator">=</span> <span class="token function">flip</span><span class="token punctuation">(</span><span class="token function">curryN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> decode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// (方式一)</span>
<span class="token keyword">const</span> <span class="token function-variable function">decodeHTML</span> <span class="token operator">=</span> <span class="token parameter">charset</span> <span class="token operator">=&gt;</span> <span class="token function">curryN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> decode<span class="token punctuation">)</span><span class="token punctuation">(</span>__<span class="token punctuation">,</span> charset<span class="token punctuation">)</span> <span class="token comment">// (方式二)</span>

<span class="token keyword">const</span> <span class="token function-variable function">getHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> charset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">composeP</span><span class="token punctuation">(</span>
    <span class="token function">decodeHTML</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p
  <span class="token punctuation">)</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
</code></pre></div><p>更多函数式知识请<a href="https://adispring.coding.me/categories/Thinking-in-Ramda/" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="content__footer-container"><div class="content__footer"><!----> <!----></div></div></div></div></div></div></div>
    <script src="/electron-flyer/assets/js/app.22e63a91.js" defer></script><script src="/electron-flyer/assets/js/10.d6a7e726.js" defer></script>
  </body>
</html>
