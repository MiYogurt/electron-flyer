<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>拉取商店列表 | 破晓：黑夜之中的 Electron 飞行指南</title>
    <meta name="description" content="🎨 Electron 没那么难">
    
    
    <link rel="preload" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css" as="style"><link rel="preload" href="/electron-flyer/assets/js/app.22e63a91.js" as="script"><link rel="preload" href="/electron-flyer/assets/js/11.887eb323.js" as="script"><link rel="prefetch" href="/electron-flyer/assets/js/10.d6a7e726.js"><link rel="prefetch" href="/electron-flyer/assets/js/12.91b28bd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/13.2a080c63.js"><link rel="prefetch" href="/electron-flyer/assets/js/14.e6db4937.js"><link rel="prefetch" href="/electron-flyer/assets/js/15.4888b394.js"><link rel="prefetch" href="/electron-flyer/assets/js/16.6209dfc4.js"><link rel="prefetch" href="/electron-flyer/assets/js/17.4dabdbda.js"><link rel="prefetch" href="/electron-flyer/assets/js/18.d91d10ee.js"><link rel="prefetch" href="/electron-flyer/assets/js/19.2288f168.js"><link rel="prefetch" href="/electron-flyer/assets/js/2.182ecb78.js"><link rel="prefetch" href="/electron-flyer/assets/js/20.1d66ae28.js"><link rel="prefetch" href="/electron-flyer/assets/js/21.1073c24e.js"><link rel="prefetch" href="/electron-flyer/assets/js/22.9864bcb1.js"><link rel="prefetch" href="/electron-flyer/assets/js/23.0099ea93.js"><link rel="prefetch" href="/electron-flyer/assets/js/24.2924e65e.js"><link rel="prefetch" href="/electron-flyer/assets/js/25.9ffdaddc.js"><link rel="prefetch" href="/electron-flyer/assets/js/26.549bcbd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/3.7de79766.js"><link rel="prefetch" href="/electron-flyer/assets/js/4.fa89f104.js"><link rel="prefetch" href="/electron-flyer/assets/js/5.968ec6b8.js"><link rel="prefetch" href="/electron-flyer/assets/js/6.0f1acbba.js"><link rel="prefetch" href="/electron-flyer/assets/js/7.08f680e1.js"><link rel="prefetch" href="/electron-flyer/assets/js/8.01be9bf3.js"><link rel="prefetch" href="/electron-flyer/assets/js/9.b7ab19cb.js">
    <link rel="stylesheet" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme__container sidebar-open"><div class="row"><div class="col-md-2"><div class="sidebar"><div class="group"><div class="group__title">章节内容</div> <div class="group__body"><!---->  <div name="1.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/1.html">历史介绍</a></div> </div><div name="2.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/2.html">开发环境</a></div> </div><div name="3.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/3.html">代码封装</a></div> </div><div name="4.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/4.html">函数式</a></div> </div><div name="5.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/5.html">获取小说命令行版（上）</a></div> </div><div name="6.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/6.html">获取小说命令行版（中）</a></div> </div><div name="7.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/7.html">获取小说命令行版（下）</a></div> </div><div name="8.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/8.html">嵌入到应用中</a></div> </div><div name="9.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/9.html">插件机制</a></div> </div><div name="10.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/10.html">文字转语音</a></div> </div><div name="11.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/11.html">设置与信号中断</a></div> </div><div name="12.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/12.html" class="router-link-exact-active router-link-active">插件商店</a></div> </div><div name="13.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/13.html">下载与删除（上）</a></div> </div><div name="14.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/14.html">下载与删除（下）</a></div> </div><div name="15.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/15.html">通知栏程序</a></div> </div><div name="16.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/16.html">播放功能</a></div> </div><div name="17.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/17.html">美化界面</a></div> </div><div name="18.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/18.html">数据可视化（上）</a></div> </div><div name="19.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/19.html">数据可视化（中）</a></div> </div><div name="20.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/20.html">数据可视化（下）</a></div> </div><div name="21.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/21.html">嵌入到应用中</a></div> </div><div name="22.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/22.html">打包应用</a></div> </div></div></div></div></div> <div class="col-md-10"><div class="page__container"><div class="content custom"><p>插件商店的实现原理其实跟脚手架差不多，比如 egg-init 、vue-cli ，首先有一个仓库存储了所有的模板与地址列表，所以我先创建了一个<a href="https://github.com/MiYogurt/reader-store" target="_blank" rel="noopener noreferrer">存储的仓库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然后我又把爬取规则创建了一个仓库， <a href="https://github.com/MiYogurt/ybdy_downloader" target="_blank" rel="noopener noreferrer">ybdy_downloader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="拉取商店列表"><a href="#拉取商店列表" aria-hidden="true" class="header-anchor">#</a> 拉取商店列表</h2> <p>首先我们将 loadPlugins 改成 plugins , 这样我们就可以把 plugin 的所有逻辑都放到这个里面来。然后我们将插件保存的目录也改成可配置的。修改 <code>plugins.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> pluginsPath <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
  <span class="token string">'PLUGIN_PATH'</span><span class="token punctuation">,</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.reader-app-scripts'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token function">ensureDirSync</span><span class="token punctuation">(</span>pluginsPath<span class="token punctuation">)</span>
</code></pre></div><p>修改 <code>tray.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token constant">PLUGIN_PATH</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'path'</span><span class="token punctuation">,</span>
  label<span class="token punctuation">:</span> <span class="token string">' 插件路径'</span><span class="token punctuation">,</span>
  defaultValue<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.reader-app-scripts'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>修改 <code>setting.ts</code> , 我们需要添加一个刷新的逻辑。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">fetchAllPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">send<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从远端获取所有新插件</span>
  <span class="token function">promisified</span><span class="token punctuation">(</span>storeURL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> db <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      db <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'all_plugins'</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span> <span class="token comment">// 发送到渲染进程</span>
    store<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'ALL_PLUGINS'</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span> <span class="token comment">// 保存到 store</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'reload_all_plugins'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">fetchAllPlugins</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>send<span class="token punctuation">)</span>
  ipcMain<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'get_all_plugins'</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token comment">// 触发自己的 get_all_plugins 事件</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'get_all_plugins'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'ALL_PLUGINS'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> event<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'all_plugins'</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">fetchAllPlugins</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>send<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>为了让插件支持热更新，需要通过事件触发更新，假设把 plugin 丢到 store 里面去，由于序列化，会导致爬取方法丢失，所以只能存一下文件名做一下缓存。修改 <code>index.ts</code> 的 <code>ready</code> 方法，当然也可以用一个方法，比如 <code>pluginSetUp</code> 把下面的逻辑包裹一下。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> temPlugins<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  plugins <span class="token operator">=</span> temPlugins
<span class="token punctuation">}</span>

<span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'reload_local_plugins'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>load<span class="token punctuation">)</span>
</code></pre></div><p>再次修改 <code>plugins.ts</code> , 我们需要 <code>filename</code> 来判断该插件是否已经下载过了, 当接收到 <code>reload_local_plugins</code> 信号更新配置，这不仅会触发 <code>index.ts</code> 的事件监听，还会触发 <code>plugins.ts</code> 里的事件监听。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">loadPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token function">readdirSync</span><span class="token punctuation">(</span>pluginsPath<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    files<span class="token punctuation">,</span> <span class="token comment">// 文件名，因为要判断本地已安装插件</span>
    files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">filename</span> <span class="token operator">=&gt;</span>
      <span class="token function">requireFoolWebpack</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>pluginsPath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>requireFoolWebpack<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">saveToSetting</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">all<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> event<span class="token punctuation">,</span> args <span class="token punctuation">}</span> <span class="token operator">=</span> all
  <span class="token keyword">const</span> <span class="token punctuation">[</span>files<span class="token punctuation">,</span> _<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'LOACAL_PLUGINS'</span><span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token comment">// 将已安装插件，存入 store</span>
  event <span class="token operator">&amp;&amp;</span> ipcMain<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'get_local_plugins'</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token comment">// 发送到渲染进程</span>
<span class="token punctuation">}</span>
<span class="token function">saveToSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'reload_local_plugins'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>saveToSetting<span class="token punctuation">)</span>
<span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'get_local_plugins'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'local_plugins'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'LOACAL_PLUGINS'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="完成前端"><a href="#完成前端" aria-hidden="true" class="header-anchor">#</a> 完成前端</h2> <p>首先安装以下依赖，来支持简介的 <code>markdown</code> 渲染支持。</p> <div class="language- extra-class"><pre class="language-text"><code>npm install marked --save
</code></pre></div><p>修改 <code>package.json</code>，将 <code>markd</code> 打包进去，要不然会找不到 <code>marked</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;electronWebpack&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;whiteListedModules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;marked&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新建 <code>pages/CrawlStore.svelte</code> , 大多数东西跟 Vue 比较类似，<code>helpers</code> 是在模板里面访问的方法，它是纯函数，不具备 <code>this</code> 的访问能力。在 <code>oncreate</code> 的时候通过事件捕获 <code>a</code> 标签的点击，使用浏览器打开链接，以及拉取数据。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>插件列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name"><span class="token namespace">ref:</span>list</span><span class="token punctuation">&gt;</span></span>
    {#each plugins as plugin}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span>{plugin.repository}</span><span class="token punctuation">&gt;</span></span>{plugin.filename} - {plugin.author} { plugin.downloaded ? 'downloaed' : ''}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{@html marked(plugin.description || '')}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    {/each}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">import</span> <span class="token punctuation">{</span>
        ipcRenderer <span class="token keyword">as</span> ipc<span class="token punctuation">,</span>
        shell
    <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'electron'</span>
    <span class="token keyword">import</span> marked <span class="token keyword">from</span> <span class="token string">'marked'</span>

    <span class="token keyword">function</span> <span class="token function">addDownloaed</span><span class="token punctuation">(</span><span class="token parameter">plugins<span class="token punctuation">,</span> local_plugins</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> plugins<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            plugin<span class="token punctuation">.</span>downloaded <span class="token operator">=</span> local_plugins<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">local_plugin</span> <span class="token operator">=&gt;</span> local_plugin <span class="token operator">==</span> plugin<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span>
            <span class="token keyword">return</span> plugin
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                local_plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                all_plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        helpers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            marked<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">plugins</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
                all_plugins<span class="token punctuation">,</span>
                local_plugins
            <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">addDownloaed</span><span class="token punctuation">(</span>all_plugins<span class="token punctuation">,</span> local_plugins<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">oncreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ipc<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'get_all_plugins'</span><span class="token punctuation">)</span>
            ipc<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'get_local_plugins'</span><span class="token punctuation">)</span>
            ipc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'all_plugins'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> all_plugins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    all_plugins
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            ipc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'local_plugins'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> local_plugins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    local_plugins
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 处理插件的打开链接</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    shell<span class="token punctuation">.</span><span class="token function">openExternal</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>最后别忘记在 App.svelte 里面引入并装载它。</p> <p>现在的结果看起来会像下面这样，因为还没有任何样式，所以可能看起来比较简陋。</p> <p><img src="/electron-flyer/assets/img/store-list.9ddbbca4.png" alt="store-list"></p> <h2 id="实现路由与全局状态"><a href="#实现路由与全局状态" aria-hidden="true" class="header-anchor">#</a> 实现路由与全局状态</h2> <p>我们来为 svelte 添加路由支持，svelte 自身是不带路由组件的， 因为作者更希望开发者自己去控制，所以也导致了难度有一些提升。</p> <p>由于我们是 Electron 环境，没必要在意浏览器的 url 是什么，所以我们根本就不需要关心浏览器前进、后退的兼容，与参数解析。</p> <p>下面是几个 svlte 路由的库和例子，大家想研究的话可以去看一下</p> <ul><li>https://github.com/krasimir/navigo</li> <li>https://github.com/ilog2000/svelte-navigo</li> <li>https://github.com/EmilTholin/svelte-routing</li> <li>https://github.com/Rich-Harris/roadtrip</li></ul> <h2 id="创建-store-js"><a href="#创建-store-js" aria-hidden="true" class="header-anchor">#</a> 创建 store.js</h2> <p>为了持久化存储，Svelte 自带了全局状态管理，为了更好的项目结构，我们将之前写好的页面都放到 pages 文件下。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Store <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'svelte/store.js'</span>
<span class="token keyword">import</span> Status <span class="token keyword">from</span> <span class="token string">'./pages/Status.svelte'</span>
<span class="token keyword">import</span> Download <span class="token keyword">from</span> <span class="token string">'./pages/Download.svelte'</span>
<span class="token keyword">import</span> CrawlStore <span class="token keyword">from</span> <span class="token string">'./pages/CrawlStore.svelte'</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  currentPage<span class="token punctuation">:</span> Status <span class="token comment">// 当前页面</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

store<span class="token punctuation">.</span>changePage <span class="token operator">=</span> <span class="token function">changePage</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">changePage</span><span class="token punctuation">(</span><span class="token parameter">pageName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span>
    Status<span class="token punctuation">,</span>
    Download<span class="token punctuation">,</span>
    CrawlStore
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>currentPage <span class="token comment">//当前页</span>
  store<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> currentPage<span class="token punctuation">:</span> map<span class="token punctuation">[</span>pageName<span class="token punctuation">]</span> <span class="token operator">||</span> current <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> changePage <span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre></div><p>我是直接通过  添加到实例上面添加的方法，大家也可以参考官方的文档，按照官方的例子去做。</p> <p>这里我们通过 <code>changePage</code> 来修改 currentPage 变量，然后我们把 currentPage 绑定到动态组件上面去，这样我们就实现了路由。</p> <h2 id="修改-app-svelte"><a href="#修改-app-svelte" aria-hidden="true" class="header-anchor">#</a> 修改 App.svelte</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Hello<span class="token punctuation">&quot;</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Download<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>下载页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Hello<span class="token punctuation">&quot;</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>状态<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Hello<span class="token punctuation">&quot;</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>CrawlStore<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>爬虫商店<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">svelte:</span>component</span> <span class="token attr-name">this</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{$currentPage}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        components<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            Link<span class="token punctuation">:</span> <span class="token string">'./components/Link.svelte'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样我们就实现了路由，但是我们还需要切换，所有我们构建一个 Link 组件。</p> <h2 id="跳转组件"><a href="#跳转组件" aria-hidden="true" class="header-anchor">#</a> 跳转组件</h2> <p>新建 <code>components/Link.svelte</code> ，阻止默认事件，修改全局状态即可。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span>{className}</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span>{to}</span> <span class="token attr-name"><span class="token namespace">ref:</span>link</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        <span class="token function">oncreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止默认事件</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">changePage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <div class="content__footer-container"><div class="content__footer"><!----> <!----></div></div></div></div></div></div></div>
    <script src="/electron-flyer/assets/js/app.22e63a91.js" defer></script><script src="/electron-flyer/assets/js/11.887eb323.js" defer></script>
  </body>
</html>
