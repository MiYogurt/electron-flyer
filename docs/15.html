<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安装依赖 | 破晓：黑夜之中的 Electron 飞行指南</title>
    <meta name="description" content="🎨 Electron 没那么难">
    
    
    <link rel="preload" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css" as="style"><link rel="preload" href="/electron-flyer/assets/js/app.37dc6e8c.js" as="script"><link rel="preload" href="/electron-flyer/assets/js/9.b7ab19cb.js" as="script"><link rel="prefetch" href="/electron-flyer/assets/js/10.d6a7e726.js"><link rel="prefetch" href="/electron-flyer/assets/js/11.887eb323.js"><link rel="prefetch" href="/electron-flyer/assets/js/12.91b28bd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/13.2a080c63.js"><link rel="prefetch" href="/electron-flyer/assets/js/14.e6db4937.js"><link rel="prefetch" href="/electron-flyer/assets/js/15.4888b394.js"><link rel="prefetch" href="/electron-flyer/assets/js/16.6209dfc4.js"><link rel="prefetch" href="/electron-flyer/assets/js/17.4dabdbda.js"><link rel="prefetch" href="/electron-flyer/assets/js/18.d91d10ee.js"><link rel="prefetch" href="/electron-flyer/assets/js/19.2288f168.js"><link rel="prefetch" href="/electron-flyer/assets/js/2.6cf72073.js"><link rel="prefetch" href="/electron-flyer/assets/js/20.1d66ae28.js"><link rel="prefetch" href="/electron-flyer/assets/js/21.1073c24e.js"><link rel="prefetch" href="/electron-flyer/assets/js/22.9864bcb1.js"><link rel="prefetch" href="/electron-flyer/assets/js/23.0099ea93.js"><link rel="prefetch" href="/electron-flyer/assets/js/24.2924e65e.js"><link rel="prefetch" href="/electron-flyer/assets/js/25.9ffdaddc.js"><link rel="prefetch" href="/electron-flyer/assets/js/26.549bcbd0.js"><link rel="prefetch" href="/electron-flyer/assets/js/3.7de79766.js"><link rel="prefetch" href="/electron-flyer/assets/js/4.e4c889ba.js"><link rel="prefetch" href="/electron-flyer/assets/js/5.968ec6b8.js"><link rel="prefetch" href="/electron-flyer/assets/js/6.0f1acbba.js"><link rel="prefetch" href="/electron-flyer/assets/js/7.08f680e1.js"><link rel="prefetch" href="/electron-flyer/assets/js/8.01be9bf3.js">
    <link rel="stylesheet" href="/electron-flyer/assets/css/0.styles.3d6eb61a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme__container sidebar-open"><div class="row"><div class="col-md-2"><div class="sidebar"><div class="group"><div class="group__title">章节内容</div> <div class="group__body"><!---->  <div name="1.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/1.html">历史介绍</a></div> </div><div name="2.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/2.html">开发环境</a></div> </div><div name="3.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/3.html">代码封装</a></div> </div><div name="4.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/4.html">函数式</a></div> </div><div name="5.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/5.html">获取小说命令行版（上）</a></div> </div><div name="6.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/6.html">获取小说命令行版（中）</a></div> </div><div name="7.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/7.html">获取小说命令行版（下）</a></div> </div><div name="8.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/8.html">嵌入到应用中</a></div> </div><div name="9.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/9.html">插件机制</a></div> </div><div name="10.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/10.html">文字转语音</a></div> </div><div name="11.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/11.html">设置与信号中断</a></div> </div><div name="12.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/12.html">插件商店</a></div> </div><div name="13.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/13.html">下载与删除（上）</a></div> </div><div name="14.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/14.html">下载与删除（下）</a></div> </div><div name="15.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/15.html" class="router-link-exact-active router-link-active">通知栏程序</a></div> </div><div name="16.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/16.html">播放功能</a></div> </div><div name="17.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/17.html">美化界面</a></div> </div><div name="18.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/18.html">数据可视化（上）</a></div> </div><div name="19.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/19.html">数据可视化（中）</a></div> </div><div name="20.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/20.html">数据可视化（下）</a></div> </div><div name="21.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/21.html">嵌入到应用中</a></div> </div><div name="22.html" class="group__category category"><div class="category__label"><a href="/electron-flyer/22.html">打包应用</a></div> </div></div></div></div></div> <div class="col-md-10"><div class="page__container"><div class="content custom"><p>这一小节，我们将我们的程序改造成通知栏程序。</p> <h2 id="安装依赖"><a href="#安装依赖" aria-hidden="true" class="header-anchor">#</a> 安装依赖</h2> <p>其实通知栏的程序就是去掉窗口的边框，然后定位到通知栏小图标的下面，通知栏是可以获得它的位置坐标的，我们可以基于这个坐标进行计算来获得。这个我们可以使用<a href="https://www.npmjs.com/package/electron-positioner" target="_blank" rel="noopener noreferrer">electron-positioner<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来帮助我们进行计算，大家也可以参考 <a href="https://github.com/maxogden/menubar/blob/master/index.js" target="_blank" rel="noopener noreferrer">menubar<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 项目进行改造。</p> <div class="language- extra-class"><pre class="language-text"><code>npm install electron-positioner --save
</code></pre></div><p>别忘记自己添加一下定义文件，<code>electron-positioner.d.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'electron-positioner'</span>
</code></pre></div><h2 id="修改-tray-ts"><a href="#修改-tray-ts" aria-hidden="true" class="header-anchor">#</a> 修改 tray.ts</h2> <p>由于我们需要控制顺序，<code>ready</code> 里面的顺序分开来看不是特别明显，所以我们提取到 <code>index.ts</code> 中，我们需要自定义 Tray 小图标的一些单击，双击，右键的事件，当计算的距离是 <code>tray</code> 开头的时候，需要传入 <code>tray.getBounds()</code> 获取的小图标坐标点。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> Positioner <span class="token keyword">from</span> <span class="token string">'electron-positioner'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> opensetting <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./tray'</span>

<span class="token keyword">let</span> tray<span class="token punctuation">:</span> Tray
<span class="token keyword">let</span> positioner<span class="token punctuation">:</span> <span class="token builtin">any</span>

<span class="token keyword">function</span> <span class="token function">setPostion</span><span class="token punctuation">(</span><span class="token parameter">win<span class="token punctuation">:</span> BrowserWindow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 得到位置</span>
  positioner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Positioner</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span>
  positioner<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string">'trayCenter'</span><span class="token punctuation">,</span> tray<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  win<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createTray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建通知栏图标</span>
  tray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tray</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'tray_w24h24.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> contextMenu <span class="token operator">=</span> Menu<span class="token punctuation">.</span><span class="token function">buildFromTemplate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> label<span class="token punctuation">:</span> <span class="token string">'设置'</span><span class="token punctuation">,</span> click<span class="token punctuation">:</span> opensetting <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      label<span class="token punctuation">:</span> <span class="token string">'退出'</span><span class="token punctuation">,</span>
      role<span class="token punctuation">:</span> <span class="token string">'quit'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">toggle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 显示隐藏</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mainWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mainWindow<span class="token punctuation">.</span><span class="token function">isVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> mainWindow<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    positioner<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string">'trayCenter'</span><span class="token punctuation">,</span> tray<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    mainWindow<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  tray<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> toggle<span class="token punctuation">)</span> <span class="token comment">// 单击</span>
  tray<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'double-click'</span><span class="token punctuation">,</span> toggle<span class="token punctuation">)</span> <span class="token comment">// 双击</span>
  tray<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'right-click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 右键菜单</span>
    tray<span class="token punctuation">.</span><span class="token function">popUpContextMenu</span><span class="token punctuation">(</span>contextMenu<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mainWindow <span class="token operator">=</span> <span class="token function">createMainWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token number">560</span><span class="token punctuation">,</span>
    frame<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    transparent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    show<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">createTray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">setPostion</span><span class="token punctuation">(</span>mainWindow<span class="token punctuation">)</span>
  <span class="token function">pluginSetUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">crawlSetUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="解决-a-标签的拖拽问题"><a href="#解决-a-标签的拖拽问题" aria-hidden="true" class="header-anchor">#</a> 解决 a 标签的拖拽问题</h2> <p>这个时候有一个小 bug , 所有的跳转按钮是可拖动的，我们需要阻止一下默认事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragstart'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/electron-flyer/assets/img/tray.1453e55e.gif" alt="Tray"></p> <h2 id="添加状态"><a href="#添加状态" aria-hidden="true" class="header-anchor">#</a> 添加状态</h2> <p>我们需要一个状态来标记是否已经开始了队列。以及添加一个警告的方法。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  currentPage<span class="token punctuation">:</span> Main<span class="token punctuation">,</span>
  msg<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span>
    content<span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  start<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">// 开始队列否</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">warring</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> timer <span class="token operator">=</span> <span class="token number">1000</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    msg<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">'warring'</span><span class="token punctuation">,</span>
      content
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>resetMsg<span class="token punctuation">,</span> timer<span class="token punctuation">)</span> <span class="token comment">// 自动关闭消息</span>
<span class="token punctuation">}</span>

store<span class="token punctuation">.</span>warring <span class="token operator">=</span> <span class="token function">warring</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
</code></pre></div><h2 id="修改-download-svelte"><a href="#修改-download-svelte" aria-hidden="true" class="header-anchor">#</a> 修改 Download.svelte</h2> <p>添加模板逻辑，访问全局状态，以 $ 开头。需要一个 canvas 来画进度框。包裹一层是为了居中，一定要在属性上面给确定的大小，要不然会画出来的东西就看不到了。对于 canvas 我也有录制过视屏，<a href="https://nodelover.me/course/canvas" target="_blank" rel="noopener noreferrer">在这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，不过不是免费的内容。</p> <p><code>canvas</code> 一定要通过 css 控制显隐，要不然会很难操作，动态挂载生命周期极其难控制。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Back</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {#if !$start}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>文件名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">bind:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span>folderName</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>爬取网址<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">bind:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span>url</span> <span class="token punctuation">/&gt;</span></span>
    {/if}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>oprator<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        {#if !$start}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>download()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>下载<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        {:else}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stop()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>中断<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        {/if}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

        {#if status.type }
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>type<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                {status.type == 'crawl' &amp;&amp; status.step == 'chapter' ?  '爬取章节': ''}
                {status.type == 'crawl' &amp;&amp; status.step == 'text'? '爬取内容': ''}
                {status.type == 'audio'? '转换音频': ''}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        {/if}

        {#if status.title}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                {status.title}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        {/if}

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>box {$start?'show':''}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name"><span class="token namespace">ref:</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>canvas<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>250<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>250<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>定义了颜色 <code>color</code> 它代表每一阶段进度条的颜色，然后在 oncreate 的时候，绘制 canvas。

这里我对所有的错误相关的进行了重构，错误消息都是 <code>type: 'error'</code> 的结构。当中止队列的时候不要忘记清空状态。<code>once</code> 是用来控制消息提示只调用一次，调用多次会出现 Bug，暂时无法找到何处出了问题，猜测是内置动画的原因。</p> <p>对于绘制进度条，使用了两个圆，通过 <code>arc</code> <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/arc" target="_blank" rel="noopener noreferrer">API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 进行了绘制，然后通过 <code>requestAnimationFrame</code> 逐帧绘制。每次绘制都会去状态里面取最新的值。</p> <p>对于百分比其实很简单，<code>2 * PI / 100</code> 就是百分之一 ，乘以百分比即可。为了保证画布的干净每次都需要 <code>clearRect</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> ipcRenderer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;electron&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token punctuation">:</span> <span class="token string">&quot;#00CC99&quot;</span><span class="token punctuation">,</span>
    audio<span class="token punctuation">:</span> <span class="token string">&quot;#3399CC&quot;</span><span class="token punctuation">,</span>
    stop<span class="token punctuation">:</span> <span class="token string">&quot;#FF3333&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token string">&quot;https://www.ybdu.com/xiaoshuo/0/910/&quot;</span><span class="token punctuation">,</span>
        folderName<span class="token punctuation">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
        status<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          type<span class="token punctuation">:</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span>
          title<span class="token punctuation">:</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">,</span>
          percent<span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      Back<span class="token punctuation">:</span> <span class="token string">&quot;../components/Back.svelte&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">oncreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;download-status&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 接受下载状态，并渲染到 canvas</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token punctuation">(</span>args<span class="token punctuation">.</span>typw <span class="token operator">==</span> <span class="token string">&quot;audio&quot;</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>percent <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          args<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;stop&quot;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            status<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              type<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
              percent<span class="token punctuation">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> start<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
          once <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">warring</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> start<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          status<span class="token punctuation">:</span> args
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          start<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">drawFrame</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centerX <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centerY <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">whiteCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">blueCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>drawFrame<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每帧自动渲染</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">ondestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token string">&quot;download-status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">download</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> folderName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> folderName<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;download&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            url<span class="token punctuation">,</span>
            folderName
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> start<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;stop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>centerX <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>centerY <span class="token operator">=</span> canvas<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rad <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> status <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存之前的转态。</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#888&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token string">&quot;40px Arial&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>textAlign <span class="token operator">=</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>textBaseline <span class="token operator">=</span> <span class="token string">&quot;middle&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>percent <span class="token operator">+</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centerY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 恢复之前的转态。</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">blueCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 上层进度全</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> status <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> color<span class="token punctuation">[</span>status<span class="token punctuation">.</span>step<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;#9900FF&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 绘制颜色</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span> <span class="token comment">// 绘制圆</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>centerX<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>centerY<span class="token punctuation">,</span>
          <span class="token number">100</span><span class="token punctuation">,</span>
          <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> status<span class="token punctuation">.</span>percent <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rad<span class="token punctuation">,</span>
          <span class="token boolean">false</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">whiteCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 底层白圈</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;#383a41&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>centerY<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="添加重试与等待机制"><a href="#添加重试与等待机制" aria-hidden="true" class="header-anchor">#</a> 添加重试与等待机制</h2> <p>有的时候会报 <code>getaddrinfo ENOTFOUND</code> 错误，我们添加一个重试的机制。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> getMp3Data<span class="token punctuation">:</span> <span class="token function-variable function">any</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> opts<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> textArr <span class="token operator">=</span> <span class="token function">splitText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    textArr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">text2audio</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
      <span class="token keyword">return</span> data
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getMp3Data</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再添加一个等待机制，自行到 <code>tray.ts</code> 里面添加配置哦，这样可以减小网络出错的概率。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token constant">TTS_WAIT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="忽略错误"><a href="#忽略错误" aria-hidden="true" class="header-anchor">#</a> 忽略错误</h2> <p>在测试的时候，发现  总是有的时候会遇见 <code>mp3-concat</code> 有错误，会弹出选项框，这就很不友好，但是实际内容是没有丢失的，我们可以直接忽略掉它，修改 <code>index.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token builtin">console</span><span class="token punctuation">.</span>log<span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token builtin">console</span><span class="token punctuation">.</span>log<span class="token punctuation">)</span>
</code></pre></div><p><img src="/electron-flyer/assets/img/download_story.5eebfcb7.gif" alt="download"></p></div> <div class="content__footer-container"><div class="content__footer"><!----> <!----></div></div></div></div></div></div></div>
    <script src="/electron-flyer/assets/js/app.37dc6e8c.js" defer></script><script src="/electron-flyer/assets/js/9.b7ab19cb.js" defer></script>
  </body>
</html>
